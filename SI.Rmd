---
title: "SI"
author: "Susanne Kortsch"
date: "1 3 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This the supplementary information for the paper "Habitat heterogeneity and pollinator plant preferences drive functioning of *in silico* plant-pollinator networks"


```{r load, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load packages
library("tidyverse")  #Needed to easily summarise and analyse data 
library("lubridate")  #Getting R to agree that your data contains the dates and times
library("bipartite")
library("ggpubr")     #arrange plot
library("sjPlot")     #visualizing results
library("sjmisc")
library("moments")    #for calculating kurtosis
library("ggeffects")
library("showtext")   #https://albert-rapp.de/post/2022-02-19-ggplot2-color-tips-from-datawrapper/?s=09
library("thematic")
library("MASS")

```


```{r data setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#data 
setwd("C:/LocalData/susakort/pollinatorsNL-main_18/R_scripts") #setwd to your own directory
vis_data<-read.csv("../Data_output/NLdata.csv", header=TRUE) #inport data

vis_data<- vis_data %>% rowwise() %>% mutate(pref.diff = abs(plant.pref -  prefs_after_vis))

df.vis.sum<-vis_data %>% group_by(run, seed_percent, free.dist, plant_species, pl.dens) %>%  summarise(pl.pref=mean(plant.pref), 
number_visits = sum(number_visits), cons= sum(cons), pvis=sum(pvis), connectance=mean(conn), nestedness= mean(nest), tot.plant.dens=mean(plant.density)) 

df.vis<-df.vis.sum %>% group_by(run, seed_percent) %>% summarise(pl.pref=mean(pl.pref), pl.dens=mean(pl.dens), 
  number_visits = median(number_visits), cons= median(cons), 
  pvis=median(pvis), connectance=mean(connectance), nestedness=mean(nestedness), mean.free.dist=mean(free.dist),tot.plant.dens=median(tot.plant.dens)) 

df.vis.sum.poll<-vis_data %>% group_by(run, seed_percent, pollinator_species, pl.dens) %>%  summarise(pl.pref=mean(plant.pref), 
number_visits = sum(number_visits), cons= sum(cons), pvis=sum(pvis), connectance=mean(conn), nestedness= mean(nest), mean.diff=mean(pref.diff)) 

df.vis.poll<-df.vis.sum.poll %>% group_by(run, seed_percent) %>% summarise(pl.pref=mean(pl.pref), pl.dens=mean(pl.dens), 
  number_visits = median(number_visits), cons= median(cons), pvis=median(pvis), connectance=mean(connectance), nestedness=mean(nestedness), pref.diff=mean(mean.diff))

#visit per plant
vis.per.plant<-vis_data %>% group_by(run, seed_percent, conn, nest, plant_species) %>% summarize(number_visits = sum(number_visits), cons = sum(cons), pvis = sum(pvis), pl.no=mean(plant.density)) 

tot.vis<-vis.per.plant %>% group_by(run, seed_percent, connectance=conn, nest) %>% summarize(sum.vis = sum(number_visits), sum.cons = sum(cons), sum.pvis = sum(pvis), pl.no=sum(pl.no))

#rel visit per plant
rel.vis<-vis.per.plant %>% inner_join(vis.per.plant) %>% mutate(rel.vis=number_visits/pl.no, rel.cons=cons/pl.no, rel.pvis=pvis/pl.no)

#rel visit per plant
rel.vis<-tot.vis %>% inner_join(tot.vis) %>% mutate(rel.vis=sum.vis/pl.no, rel.cons=sum.cons/pl.no, rel.pvis=sum.pvis/pl.no)

```

##### Variation in visitation measures along gradients of habitat heterogeniety

```{r plot1, echo=FALSE, message=FALSE, results='hide', ,fig.keep='all', fig.height=6, fig.width=8, fig.align = 'center'}

# set up cut-off values 
breaks <- c( 0.00005, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
tags <- c( "[0.00005-0.0001)", "[0.0001-0.0005)",  "[0.0005-0.001)", "[0.001-0.005)", "[0.005-0.01)", 
           "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[0.4-0.6)","[0.6-0.8)", "[0.8-1)")
# bucketing values into bins
tot.vis$bins_seed <- cut(tot.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

bin.seed1<-ggplot(tot.vis, aes(x = factor(bins_seed), y = sum.vis)) + xlab("seed percent") + 
  ylab("total visitation rate") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
   geom_boxplot(fill="bisque",color="black",alpha=0.3)+  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 20000, label.x = 9, label = "p.format")

bin.seed2<-ggplot(tot.vis, aes(x = factor(bins_seed), y = sum.cons)) + xlab("seed percent") + 
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("total consecutive visits") +  theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 15000, label.x = 9,label = "p.format")
# stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

bin.seed3<-ggplot(tot.vis, aes(x = factor(bins_seed), y = sum.pvis)) + xlab("seed percent") + 
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("total expected pollination success") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 15000, label.x = 9, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red"

ggarrange(bin.seed1, bin.seed2, bin.seed3 ,  labels = c("A", "B", "C"), ncol = 3)

```

**Figure 1:**Relationship between total visitation rate, total consecutive visits, total pollination expected successul pollination and seed percentage. The Y axis shows the expected visits of the binned seed percentage (x axis) values.

```{r plot1b, echo=FALSE, message=FALSE, results='hide', ,fig.keep='all', fig.height=6, fig.width=8, fig.align = 'center'}

# set up cut-off values 
breaks <- c( 0.00005, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
tags <- c( "[0.00005-0.0001)", "[0.0001-0.0005)",  "[0.0005-0.001)", "[0.001-0.005)", "[0.005-0.01)", 
           "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[0.4-0.6)","[0.6-0.8)", "[0.8-1)")
# bucketing values into bins
df.vis$bins_seed <- cut(df.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

bin.seed1<-ggplot(df.vis, aes(x = factor(bins_seed), y = number_visits)) + xlab("seed percent") + 
  ylab("visitation rate") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
   geom_boxplot(fill="bisque",color="black",alpha=0.3)+  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 3900, label.x = 2, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

bin.seed2<-ggplot(df.vis, aes(x = factor(bins_seed), y = cons)) + xlab("seed percent") + 
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("consecutive visits") +  theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 3900, label.x = 2,label = "p.format")
# stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

bin.seed3<-ggplot(df.vis, aes(x = factor(bins_seed), y = pvis)) + xlab("seed percent") + 
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("expected pollination success") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 3900, label.x = 2, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red"

ggarrange(bin.seed1, bin.seed2, bin.seed3 ,  labels = c("A", "B", "C"), ncol = 3)

```

**Figure 2:**Relationship between median visitation rate, consecutive visits, pollination probability visits and seed percentage. The Y axis shows the expected visits of the binned seed percentage (x axis) values.


```{r plot1c, echo=FALSE, message=FALSE, results='hide', ,fig.keep='all', fig.height=6, fig.width=8, fig.align = 'center'}

breaks <- c( 0.00005, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
tags <- c( "[0.00005-0.0001)", "[0.0001-0.0005)",  "[0.0005-0.001)", "[0.001-0.005)", "[0.005-0.01)", 
           "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[0.4-0.6)","[0.6-0.8)", "[0.8-1)")
# bucketing values into bins
rel.vis$bins_seed <- cut(rel.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

bin.seed1<-ggplot(rel.vis, aes(x = factor(bins_seed), y = rel.vis)) + xlab("seed percent") + 
  ylab("visitation rate") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+  guides(x =  guide_axis(angle = 90)) +
  stat_compare_means(label.y = 0.6, label.x = 9, label = "p.format")

bin.seed2<-ggplot(rel.vis, aes(x = factor(bins_seed), y = rel.cons)) + xlab("seed percent") + 
  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("consecutive visits") +  theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
  stat_compare_means(label.y = 0.3, label.x = 9,label = "p.format")
 #stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

bin.seed3<-ggplot(rel.vis, aes(x = factor(bins_seed), y = rel.pvis)) + xlab("seed percent") + 
geom_boxplot(fill="bisque",color="black",alpha=0.3)+
  ylab("expected pollination success") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2),  alpha=0.2)+
  guides(x =  guide_axis(angle = 90)) +
   stat_compare_means(label.y = 0.3, label.x = 9, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red")

ggarrange(bin.seed1, bin.seed2, bin.seed3 ,  labels = c("A", "B", "C"), ncol = 3)

```

**Figure 2:**Relationship between relative visitation rate, consecutive visits, pollination probability visits and seed percentage. The Y axis shows the expected visits of the binned seed percentage (x axis) values.



```{r plot1d, echo=FALSE, message=FALSE, results='hide', ,fig.keep='all', fig.height=6, fig.width=8, fig.align = 'center'}

# set up cut-off values 
#breaks <- c( 55, 50, 45, 40, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
#tags <- c( "[55-405)", "[45-35)",  "[35-25)", "[25-20)", "[20-0.15)", 
 #          "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[1.8-1.4)","[1.4-1.2)", "[1.2-1)")
# bucketing values into bins
#df.vis$bins_seed <- cut(df.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

#cut_interval(df.vis$mean.free.dist, n = 10)

#breaks <- c( 26.6, 21.5, 18.9,  13.8, 11.2, 8.68, 6.12,3.57,2, 1.3, 1.05, 1.01)
##tags<-c("[1.01,1.05]", "[1.05,1.2]", "[1.2,2]", "[2,3.57]", "(3.57,6.12]", "(6.12,8.68]", "(8.68,11.2]", "(11.2,13.8]" ,"(13.8, 18.9]", "(18.9,21.5]" ,"(21.5,26.6]")
#df.vis$bins_path <- cut(df.vis$mean.free.dist, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)
#table(df.vis$bins_path)

#plot(log(df.vis$seed_percent), log(df.vis$mean.free.dist))
#
#bin.seed1<-ggplot(df.vis, aes(x = factor(bins_path), y = number_visits)) + xlab("habitat heterogenity") + 
 # ylab("visitation rate") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
 #  geom_boxplot(fill="bisque",color="black",alpha=0.3)+  guides(x =  guide_axis(angle = 90)) +
 #  stat_compare_means(label.y = 3900, label.x = 2, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

#bin.seed2<-ggplot(df.vis, aes(x = factor(bins_path), y = cons)) + xlab("habitat heterogenity") + 
#  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
# ylab("consecutive visits") +  theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
#  guides(x =  guide_axis(angle = 90)) +
#   stat_compare_means(label.y = 3900, label.x = 2,label = "p.format")
# stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red") +

#bin.seed3<-ggplot(df.vis, aes(x = factor(bins_path), y = pvis)) + xlab("habitat heterogenity") + 
#  geom_boxplot(fill="bisque",color="black",alpha=0.3)+
# ylab("expected pollination success") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.2)+
 # guides(x =  guide_axis(angle = 90)) +
  # stat_compare_means(label.y = 3900, label.x = 2, label = "p.format")
#stat_summary(geom = "point",fun = "median",col = "black",size = 4,shape = 21,fill = "red"

#ggarrange(bin.seed1, bin.seed2, bin.seed3 ,  labels = c("A", "B", "C"), ncol = 3)

```


##### Do pollination visits vary with input network structure? 

```{r plot4, echo=FALSE, message=FALSE, results='hide', fig.keep='all', fig.height=4, fig.width=7, fig.align = 'center'}
# #### Relationship between input nestedness and connectance
#nest.conn<-ggplot(df.vis, aes(x = connectance, y = nestedness)) + geom_point(alpha=0.5) + theme_light()+ geom_smooth(col="red")+
#  stat_cor() 
#nest.conn
```


```{r plot2, echo=FALSE, message=FALSE, results='hide', fig.keep='all', fig.height=4, fig.width=7, fig.align = 'center'}
#Plot visits as a function of input connectance 

# set up cut-off values 
breaks <- c( 0.00005, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
tags <- c( "[0.00005-0.0001)", "[0.0001-0.0005)",  "[0.0005-0.001)", "[0.001-0.005)", "[0.005-0.01)", 
           "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[0.4-0.6)","[0.6-0.8)", "[0.8-1)")
# bucketing values into bins
tot.vis$bins_seed <- cut(tot.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

bs1 <- tot.vis %>% mutate(cut_conn = cut(connectance,breaks=c(0.24, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.95, 1))) %>% ggplot( aes(x = factor(bins_seed), y = sum.vis)) + xlab("seed percent") + 
  ylab("visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_conn)+ theme(axis.text.x = element_text(size = 5))   

bs2 <- tot.vis %>% mutate(cut_conn = cut(connectance,breaks=c(0.24, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.95, 1))) %>% ggplot( aes(x = factor(bins_seed), y = sum.cons)) + xlab("seed percent") + 
  ylab("Consecutive visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_conn)+ theme(axis.text.x = element_text(size = 5))  


bs3 <- tot.vis %>% mutate(cut_conn = cut(connectance,breaks=c(0.24, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.95, 1))) %>% ggplot( aes(x = factor(bins_seed), y = sum.pvis)) + xlab("seed percent") + 
  ylab("geometric decay visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_conn)+ theme(axis.text.x = element_text(size = 5))  


ggarrange(bs1, bs2, bs3 ,  labels = c("A", "B", "C"), nrow = 3)


```

**Figure 2:** Relationship between visitation rate, consecutive visits, expected pollination visits and binary input network connectance. 


```{r plot2b, echo=FALSE, message=FALSE, results='hide', fig.keep='all', fig.height=4, fig.width=7, fig.align = 'center'}
#Plot visits as a function of input connectance 

# set up cut-off values 
breaks <- c( 0.00005, 0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.00, 0.2, 0.4,0.6,0.8, 1)
# specify interval/bin labels
tags <- c( "[0.00005-0.0001)", "[0.0001-0.0005)",  "[0.0005-0.001)", "[0.001-0.005)", "[0.005-0.01)", 
           "[0.01-0.05)","[0.05-0.00)", "[0.0-0.2)", "[0.2-0.4)","[0.4-0.6)","[0.6-0.8)", "[0.8-1)")
# bucketing values into bins
tot.vis$bins_seed <- cut(tot.vis$seed_percent, breaks=breaks, include.lowest=TRUE, right=FALSE, labels=tags)

bs1 <- tot.vis %>% mutate(cut_nest = cut(nest,breaks=c(-.99, 0, 25, 45, 55, 65, 85))) %>% ggplot( aes(x = factor(bins_seed), y = sum.vis)) + xlab("seed percent") + 
  ylab("visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_nest)+ theme(axis.text.x = element_text(size = 5))   

bs2 <- tot.vis %>% mutate(cut_nest = cut(nest,breaks=c(-.99, 0, 25, 45, 55, 65, 85))) %>% ggplot( aes(x = factor(bins_seed), y = sum.cons)) + xlab("seed percent") + 
  ylab("Consecutive visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_nest)+ theme(axis.text.x = element_text(size = 5))  


bs3 <- tot.vis %>% mutate(cut_nest = cut(nest,breaks=c(-.99, 0, 25, 45, 55, 65, 85))) %>% ggplot( aes(x = factor(bins_seed), y = sum.pvis)) + xlab("seed percent") + 
  ylab("geometric decay visits") + theme_light() + geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5)+
  stat_summary(geom = "point",fun = "median",col = "black",size = 2,shape = 21,fill = "red") + guides(x =  guide_axis(angle = 90)) + facet_wrap( ~cut_nest)+ theme(axis.text.x = element_text(size = 5))  


ggarrange(bs1, bs2, bs3 ,  labels = c("A", "B", "C"), nrow = 3)


```

**Figure 3:** Relationship between visitation rate, consecutive visits, pollination probability visits and input nestedness

